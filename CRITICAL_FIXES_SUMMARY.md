# í¬ë¦¬í‹°ì»¬ ë³´ì™„ ì‘ì—… ì™„ë£Œ ë³´ê³ ì„œ

## âœ… ì™„ë£Œëœ í¬ë¦¬í‹°ì»¬ ìˆ˜ì •ì‚¬í•­

### 1ï¸âƒ£ ì˜ˆì‚° "ì˜ˆì•½-í™•ì •" ë™ì¼ íŠ¸ëœì­ì…˜ í†µí•© âœ…

**ë¬¸ì œì :**
- ê¸°ì¡´: `check_budget_availability()`ê°€ ì˜ˆì‚°ì„ ì„ ì°¨ê°í•œ í›„ ë³„ë„ë¡œ bid ì €ì¥
- í›„ì† ë‹¨ê³„ ì‹¤íŒ¨ ì‹œ ì˜ˆì‚°ì´ ì†Œì§„ëœ ì±„ë¡œ ë‚¨ëŠ” ìœ„í—˜

**í•´ê²°ì±…:**
- `reserve_and_insert_bid()` í•¨ìˆ˜ë¡œ ì˜ˆì‚° ì˜ˆì•½ê³¼ bid ì €ì¥ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ í†µí•©
- `_reserve_budget_tx()` í•¨ìˆ˜ ìƒì„± (íŠ¸ëœì­ì…˜ ë‚´ë¶€ì—ì„œë§Œ í˜¸ì¶œ)

**ì£¼ìš” ë³€ê²½ì‚¬í•­:**
- `services/auction_service/main.py`:
  - `check_budget_availability()` ì œê±°
  - `_reserve_budget_tx()` ì¶”ê°€ (KST ê¸°ì¤€ ì¼ì¼ ê²½ê³„ ì ìš©)
  - `reserve_and_insert_bid()` ì¶”ê°€ (ì›ìì  ì²˜ë¦¬)
  - `/start` ì—”ë“œí¬ì¸íŠ¸ì—ì„œ `reserve_and_insert_bid()` í˜¸ì¶œë¡œ ë³€ê²½
  - `generate_real_advertiser_bids()`ì—ì„œ ì˜ˆì‚° í™•ì¸ ì œê±° (BidResponseë§Œ ìƒì„±)

**ê²°ê³¼:**
- ì˜ˆì‚° ì°¨ê°ê³¼ bid ì €ì¥ì´ ì›ìì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ ì¼ê´€ì„± ë³´ì¥
- ì˜ˆì‚° ëˆ„ìˆ˜ ë°©ì§€

### 2ï¸âƒ£ "í•˜ë£¨ ê²½ê³„" ì •ì±… í™•ì • (KST ê¸°ì¤€) âœ…

**ë³€ê²½ì‚¬í•­:**
- ëª¨ë“  ì˜ˆì‚° ì§‘ê³„ë¥¼ KST ê¸°ì¤€ìœ¼ë¡œ ë³€ê²½
- `timezone('Asia/Seoul', now())::date` ì‚¬ìš©

**ì ìš© ìœ„ì¹˜:**
- `_reserve_budget_tx()` í•¨ìˆ˜ì˜ ëª¨ë“  ë‚ ì§œ ê´€ë ¨ ì¿¼ë¦¬

**SQL ì˜ˆì‹œ:**
```sql
-- KST ê¸°ì¤€ ì˜¤ëŠ˜ ë‚ ì§œ ì¡°íšŒ
WHERE spend_date = (timezone('Asia/Seoul', now()))::date

-- KST ê¸°ì¤€ ë‚ ì§œë¡œ ì €ì¥
INSERT INTO advertiser_daily_spend(advertiser_id, spend_date, amount)
VALUES (:aid, (timezone('Asia/Seoul', now()))::date, 0)
```

### 3ï¸âƒ£ êµ¬ì¡°ì  ë¡œê¹… ì „í™˜ âœ…

**ë³€ê²½ì‚¬í•­:**
- ì£¼ìš” `print()` ë¬¸ì„ `structlog` ê¸°ë°˜ ë¡œê¹…ìœ¼ë¡œ ì „í™˜
- ì»¨í…ìŠ¤íŠ¸ ì •ë³´ (auction_id, advertiser_id, bid_price ë“±) ë°”ì¸ë”©

**ë¡œê¹… íŒ¨í„´:**
```python
log = logger.bind(service="auction-service")
log.info("auction_start", query=query, value_score=value_score)
log.warning("budget_insufficient", advertiser_id=adv_id, bid_price=bid_price)
log.error("auction_service_error", error=str(e), exc_info=True)
```

**ì „í™˜ëœ ìœ„ì¹˜:**
- `generate_real_advertiser_bids()`: ë§¤ì¹­ ì‹œì‘/ì™„ë£Œ ë¡œê¹…
- `start_reverse_auction()`: ì—­ê²½ë§¤ ì‹œì‘/ì™„ë£Œ ë¡œê¹…
- `/start` ì—”ë“œí¬ì¸íŠ¸: ê²½ë§¤ ì‹œì‘, ì—ëŸ¬ ì²˜ë¦¬
- `log_auto_bids()`: ì…ì°° ë¡œê·¸ ê¸°ë¡
- ê¸°íƒ€ ì£¼ìš” í•¨ìˆ˜ë“¤

### 4ï¸âƒ£ ë ˆì´íŠ¸ë¦¬ë°‹ ì¶”ê°€ âœ…

**êµ¬í˜„:**
- IP + ì¿¼ë¦¬ í•´ì‹œ ê¸°ì¤€ ë ˆì´íŠ¸ë¦¬ë°‹
- 10ì´ˆì— ìµœëŒ€ 3íšŒ ìš”ì²­ ì œí•œ
- ê°„ë‹¨í•œ ì¸ë©”ëª¨ë¦¬ êµ¬í˜„ (í”„ë¡œë•ì…˜ì—ì„œëŠ” Redis ê¶Œì¥)

**êµ¬í˜„ ìœ„ì¹˜:**
- `check_rate_limit()` í•¨ìˆ˜ ì¶”ê°€
- `/start` ì—”ë“œí¬ì¸íŠ¸ì— ë ˆì´íŠ¸ë¦¬ë°‹ ì²´í¬ í†µí•©

**ì‚¬ìš©ë²•:**
```python
client_ip = http_request.client.host
if not await check_rate_limit(client_ip, request.query):
    raise HTTPException(status_code=429, detail="ë„ˆë¬´ ë§ì€ ìš”ì²­ì…ë‹ˆë‹¤.")
```

### 5ï¸âƒ£ PostgreSQL ì¸ë±ìŠ¤ ìµœì í™” í™•ì¸ âœ…

**í™•ì¸ ì™„ë£Œ:**
- `database/init.sql`ì— pg_trgm ì¸ë±ìŠ¤ ì´ë¯¸ í¬í•¨ë¨:
  - `idx_adv_kw_trgm` (GIN ì¸ë±ìŠ¤)
  - `idx_adv_kw_exact_expr`
  - `idx_cat_name_trgm` (GIN ì¸ë±ìŠ¤)
  - `idx_adv_cat_path` (text_pattern_ops)

## ğŸ“‹ í•µì‹¬ ê°œì„  íš¨ê³¼

1. **ë°ì´í„° ì •í•©ì„±**: ì˜ˆì‚° ì˜ˆì•½ê³¼ bid ì €ì¥ì´ ì›ìì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ ì˜ˆì‚° ëˆ„ìˆ˜ ë°©ì§€
2. **ì‹œê°„ëŒ€ ì¼ê´€ì„±**: KST ê¸°ì¤€ ì¼ì¼ ê²½ê³„ë¡œ ê´‘ê³ ì£¼ ì˜ˆì‚° ê´€ë¦¬ ëª…í™•í™”
3. **ìš´ì˜ ê°€ì‹œì„±**: êµ¬ì¡°ì  ë¡œê¹…ìœ¼ë¡œ ë””ë²„ê¹… ë° ëª¨ë‹ˆí„°ë§ í–¥ìƒ
4. **ë³´ì•ˆ**: ë ˆì´íŠ¸ë¦¬ë°‹ìœ¼ë¡œ ì•…ì˜ì  ìš”ì²­ ì°¨ë‹¨

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **ë ˆì´íŠ¸ë¦¬ë°‹**: í˜„ì¬ ì¸ë©”ëª¨ë¦¬ êµ¬í˜„ì´ë©°, ë©€í‹° ì„œë²„ í™˜ê²½ì—ì„œëŠ” Redis ë“± ì™¸ë¶€ ì €ì¥ì†Œ ì‚¬ìš© ê¶Œì¥
2. **ë¡œê¹…**: ë‚¨ì€ `print()` ë¬¸ì´ ì¼ë¶€ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì ì§„ì ìœ¼ë¡œ ì „í™˜ í•„ìš”
3. **í…ŒìŠ¤íŠ¸**: íŠ¸ëœì­ì…˜ í†µí•© í›„ í†µí•© í…ŒìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ í•„ìš”

## ğŸ”„ ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”ì‚¬í•­

`advertiser_daily_spend` í…Œì´ë¸”ì´ ì´ë¯¸ `init.sql`ì— í¬í•¨ë˜ì–´ ìˆìœ¼ë‚˜, ê¸°ì¡´ DBì— ì ìš©í•˜ë ¤ë©´:

```sql
-- ì´ë¯¸ init.sqlì— í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë³„ë„ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¶ˆí•„ìš”
-- í•˜ì§€ë§Œ ê¸°ì¡´ ì‹œìŠ¤í…œì´ ìˆë‹¤ë©´ í™•ì¸ í•„ìš”
```

---

**ì‘ì—… ì™„ë£Œì¼**: 2024ë…„ (í˜„ì¬ ë‚ ì§œ)  
**ìƒíƒœ**: âœ… ëª¨ë“  í¬ë¦¬í‹°ì»¬ ìˆ˜ì •ì‚¬í•­ ì™„ë£Œ

